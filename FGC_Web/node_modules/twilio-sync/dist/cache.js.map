{"version":3,"file":"cache.js","sources":["../src/cache.ts"],"sourcesContent":["import { TreeMap } from './utils/tree';\n\ninterface CacheEntry<T> {\n  value: T;\n  revision: number;\n  isValid: boolean;\n}\n\nclass Entry<T> implements CacheEntry<T> {\n  value: T;\n  revision: number;\n\n  constructor(value: T, revision: number) {\n    this.value = value;\n    this.revision = (revision || 0);\n  }\n\n  get isValid(): boolean {\n    return true;\n  }\n}\n\nclass Tombstone<T> implements CacheEntry<T> {\n  value: T;\n  revision: number;\n\n  constructor(revision: number) {\n    this.revision = revision;\n  }\n\n  get isValid(): boolean {\n    return false;\n  }\n}\n\nclass Cache<K, V> {\n  public readonly items: TreeMap<K, CacheEntry<V>>;\n\n  constructor() {\n    this.items = new TreeMap<K, CacheEntry<V>>();\n  }\n\n  store(key: K, value: V, revision: number): V {\n    let entry = this.items.get(key);\n    if (entry && entry.revision > revision) {\n      if (entry.isValid) {\n        return entry.value;\n      }\n      return null;\n    }\n    this.items.set(key, new Entry<V>(value, revision));\n    return value;\n  }\n\n  delete(key: K, revision: number, force: boolean = false): void {\n    let curr = this.items.get(key);\n    if (!curr || curr.revision < revision ||\n      (curr && force === true) /* forced delete when revision is unknown */) {\n      this.items.set(key, new Tombstone<V>(revision));\n    }\n  }\n\n  isKnown(key: K, revision: number): boolean {\n    let curr = this.items.get(key);\n    return curr && curr.revision >= revision;\n  }\n\n  get(key: K): V {\n    let entry = this.items.get(key);\n    if (entry && entry.isValid) {\n      return entry.value;\n    }\n    return null;\n  }\n\n  has(key: K): boolean {\n    let entry = this.items.get(key);\n    return entry && entry.isValid;\n  }\n\n  forEach(callbackfn: (key: K, value: V) => void): void {\n    if (this.items) {\n      for (let [key, entry] of this.items) {\n        if (entry.isValid) {\n          callbackfn(key, entry.value);\n        }\n      }\n    }\n  }\n}\n\nexport { Cache };\nexport default Cache;\n"],"names":["TreeMap"],"mappings":"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"}