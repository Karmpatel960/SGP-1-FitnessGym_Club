{"version":3,"file":"entity.js","sources":["../src/entity.ts"],"sourcesContent":["import { Services, Network, Router, Storage } from './interfaces/services';\nimport { SyncError } from './utils/syncerror';\nimport { Closeable, CloseableEvents } from './closeable';\n\ninterface EntityServices {\n  network: Network;\n  router: Router;\n  storage: Storage;\n}\n\ntype RemovalHandler = (type: string, sid: string, uniqueName: string) => void;\nexport type SubscriptionState = 'none' | 'request_in_flight' | 'response_in_flight' | 'established';\n\nabstract class SyncEntity {\n  protected readonly services: EntityServices;\n  protected readonly removalHandler: RemovalHandler;\n  private subscriptionState: SubscriptionState;\n  private readonly _attachedListeners: Map<string, Closeable>;\n\n  protected constructor(services: EntityServices, removalHandler: RemovalHandler) {\n    this.services = services;\n    this.removalHandler = removalHandler;\n    this.subscriptionState = 'none';\n    this._attachedListeners = new Map<string, Closeable>();\n  }\n\n  abstract get sid(): string;\n\n  abstract get uniqueName(): string;\n\n  abstract get type(): string;\n\n  abstract get lastEventId(): number;\n\n  abstract get indexName(): string;\n\n  abstract get queryString(): string;\n\n  abstract _update(update: any, isStrictlyOrdered: boolean): void;\n\n  _advanceLastEventId(eventId: number, revision?: string): void {\n  }\n\n  protected abstract onRemoved(locally: boolean): void;\n\n  reportFailure(err: SyncError): void {\n    if (err.status === 404) {\n      // assume that 404 means that entity has been removed while we were away\n      this.onRemoved(false);\n    } else {\n      this.broadcastEventToListeners('failure', err);\n    }\n  }\n\n  /**\n   * Subscribe to changes of data entity\n   * @private\n   */\n  _subscribe() {\n    this.services.router._subscribe(this.sid, this);\n  }\n\n  /**\n   * Unsubscribe from changes of current data entity\n   * @private\n   */\n  _unsubscribe() {\n    this.services.router._unsubscribe(this.sid);\n  }\n\n  _setSubscriptionState(newState: SubscriptionState): void {\n    this.subscriptionState = newState;\n    this.broadcastEventToListeners('_subscriptionStateChanged', newState);\n  }\n\n  /**\n   * @public\n   */\n  close() {\n    this._unsubscribe();\n    if (this.removalHandler != null) {\n      this.removalHandler(this.type, this.sid, this.uniqueName);\n    }\n  }\n\n  public attach(closeable: Closeable): void {\n    const uuid = closeable.listenerUuid;\n    const existingRecord = this._attachedListeners.get(uuid);\n    if (existingRecord) {\n      return;\n    }\n\n    if (!this._attachedListeners.size) {\n      // the first one to arrive\n      this._subscribe();\n    }\n\n    this._attachedListeners.set(uuid, closeable);\n  }\n\n  public detach(listenerUuid: string): void {\n    this._attachedListeners.delete(listenerUuid);\n    if (!this._attachedListeners.size) {\n      // last one out, turn off lights, shut the door\n      this.close(); // invokes unsubscribe and removal handler\n    }\n  }\n\n  protected broadcastEventToListeners<E extends Extract<keyof CloseableEvents, string>>(eventName: E, ...args: Parameters<CloseableEvents[E]>) {\n    for (let listener of this._attachedListeners.values()) {\n      listener.emit(eventName, ...args);\n    }\n  }\n}\n\nexport { Services, EntityServices, RemovalHandler, SyncEntity };\nexport default SyncEntity;\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAaA,MAAe,UAAU,CAAA;IAMvB,WAAsB,CAAA,QAAwB,EAAE,cAA8B,EAAA;AAC5E,QAAA,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;AACzB,QAAA,IAAI,CAAC,cAAc,GAAG,cAAc,CAAC;AACrC,QAAA,IAAI,CAAC,iBAAiB,GAAG,MAAM,CAAC;AAChC,QAAA,IAAI,CAAC,kBAAkB,GAAG,IAAI,GAAG,EAAqB,CAAC;KACxD;IAgBD,mBAAmB,CAAC,OAAe,EAAE,QAAiB,EAAA;KACrD;AAID,IAAA,aAAa,CAAC,GAAc,EAAA;AAC1B,QAAA,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG,EAAE;;AAEtB,YAAA,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;AACvB,SAAA;AAAM,aAAA;AACL,YAAA,IAAI,CAAC,yBAAyB,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC;AAChD,SAAA;KACF;AAED;;;AAGG;IACH,UAAU,GAAA;AACR,QAAA,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;KACjD;AAED;;;AAGG;IACH,YAAY,GAAA;QACV,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;KAC7C;AAED,IAAA,qBAAqB,CAAC,QAA2B,EAAA;AAC/C,QAAA,IAAI,CAAC,iBAAiB,GAAG,QAAQ,CAAC;AAClC,QAAA,IAAI,CAAC,yBAAyB,CAAC,2BAA2B,EAAE,QAAQ,CAAC,CAAC;KACvE;AAED;;AAEG;IACH,KAAK,GAAA;QACH,IAAI,CAAC,YAAY,EAAE,CAAC;AACpB,QAAA,IAAI,IAAI,CAAC,cAAc,IAAI,IAAI,EAAE;AAC/B,YAAA,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;AAC3D,SAAA;KACF;AAEM,IAAA,MAAM,CAAC,SAAoB,EAAA;AAChC,QAAA,MAAM,IAAI,GAAG,SAAS,CAAC,YAAY,CAAC;QACpC,MAAM,cAAc,GAAG,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AACzD,QAAA,IAAI,cAAc,EAAE;YAClB,OAAO;AACR,SAAA;AAED,QAAA,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE;;YAEjC,IAAI,CAAC,UAAU,EAAE,CAAC;AACnB,SAAA;QAED,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;KAC9C;AAEM,IAAA,MAAM,CAAC,YAAoB,EAAA;AAChC,QAAA,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;AAC7C,QAAA,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE;;AAEjC,YAAA,IAAI,CAAC,KAAK,EAAE,CAAC;AACd,SAAA;KACF;AAES,IAAA,yBAAyB,CAAmD,SAAY,EAAE,GAAG,IAAoC,EAAA;QACzI,KAAK,IAAI,QAAQ,IAAI,IAAI,CAAC,kBAAkB,CAAC,MAAM,EAAE,EAAE;YACrD,QAAQ,CAAC,IAAI,CAAC,SAAS,EAAE,GAAG,IAAI,CAAC,CAAC;AACnC,SAAA;KACF;AACF;;;;;"}