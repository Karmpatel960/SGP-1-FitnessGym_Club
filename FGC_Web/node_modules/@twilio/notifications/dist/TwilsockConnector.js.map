{"version":3,"file":"TwilsockConnector.js","sources":["../src/TwilsockConnector.ts"],"sourcesContent":["import * as uuid from \"uuid\";\nimport { RegistrationState, UpdateReason, Connector } from \"./connector\";\nimport { TwilsockClient } from \"twilsock\";\nimport { log } from \"./logger\";\n\n/**\n * Registrar connector implementation for twilsock -- @todo Drop twilsock.connector COMPLETELY?!\n */\nclass TwilsockConnector extends Connector {\n  private readonly contextId: string = uuid.v4();\n  /**\n   * Create twilsock registration connector.\n   * @param productId product ID\n   * @param platform platform ID string\n   * @param twilsock {TwilsockClient} connection transport.\n   */\n  constructor(\n    private readonly productId: string,\n    private readonly platform: string,\n    private readonly twilsock: TwilsockClient\n  ) {\n    super(\"twilsock\");\n  }\n\n  protected async updateRegistration(\n    registration: RegistrationState,\n    reasons: Set<UpdateReason>\n  ): Promise<RegistrationState> {\n    if (!reasons.has(\"messageType\")) {\n      // No changed message types - it is fine, finish successfully.\n      return registration;\n    }\n\n    const messageTypes = Array.from(registration.messageTypes);\n\n    const context = {\n      product_id: this.productId,\n      notification_protocol_version: 4,\n      endpoint_platform: this.platform,\n      message_types: messageTypes,\n    };\n\n    try {\n      await this.twilsock.setNotificationsContext(this.contextId, context);\n    } catch (err) {\n      log.error(`Failed to update twilsock notification context: ${err}`);\n      throw err;\n    }\n\n    return registration;\n  }\n\n  protected async removeRegistration(): Promise<void> {\n    try {\n      await this.twilsock.removeNotificationsContext(this.contextId);\n    } catch (err) {\n      log.error(`Failed to remove twilsock notification context: ${err}`);\n      throw err;\n    }\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  public async sendDeviceRemoveRequest(registrationId: string): Promise<void> {\n    // no need to do anything here, twilsock backend handles it on its own\n  }\n}\n\nexport { TwilsockConnector };\n"],"names":["Connector","uuid","log"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKA;;;AAGA,MAAM,iBAAkB,SAAQA,mBAAS;;;;;;;IAQvC,YACmB,SAAiB,EACjB,QAAgB,EAChB,QAAwB;QAEzC,KAAK,CAAC,UAAU,CAAC,CAAC;QAJD,cAAS,GAAT,SAAS,CAAQ;QACjB,aAAQ,GAAR,QAAQ,CAAQ;QAChB,aAAQ,GAAR,QAAQ,CAAgB;QAV1B,cAAS,GAAWC,eAAI,CAAC,EAAE,EAAE,CAAC;KAa9C;IAES,MAAM,kBAAkB,CAChC,YAA+B,EAC/B,OAA0B;QAE1B,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,aAAa,CAAC,EAAE;;YAE/B,OAAO,YAAY,CAAC;SACrB;QAED,MAAM,YAAY,GAAG,KAAK,CAAC,IAAI,CAAC,YAAY,CAAC,YAAY,CAAC,CAAC;QAE3D,MAAM,OAAO,GAAG;YACd,UAAU,EAAE,IAAI,CAAC,SAAS;YAC1B,6BAA6B,EAAE,CAAC;YAChC,iBAAiB,EAAE,IAAI,CAAC,QAAQ;YAChC,aAAa,EAAE,YAAY;SAC5B,CAAC;QAEF,IAAI;YACF,MAAM,IAAI,CAAC,QAAQ,CAAC,uBAAuB,CAAC,IAAI,CAAC,SAAS,EAAE,OAAO,CAAC,CAAC;SACtE;QAAC,OAAO,GAAG,EAAE;YACZC,UAAG,CAAC,KAAK,CAAC,mDAAmD,GAAG,EAAE,CAAC,CAAC;YACpE,MAAM,GAAG,CAAC;SACX;QAED,OAAO,YAAY,CAAC;KACrB;IAES,MAAM,kBAAkB;QAChC,IAAI;YACF,MAAM,IAAI,CAAC,QAAQ,CAAC,0BAA0B,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;SAChE;QAAC,OAAO,GAAG,EAAE;YACZA,UAAG,CAAC,KAAK,CAAC,mDAAmD,GAAG,EAAE,CAAC,CAAC;YACpE,MAAM,GAAG,CAAC;SACX;KACF;;IAGM,MAAM,uBAAuB,CAAC,cAAsB;;KAE1D;;;;;"}