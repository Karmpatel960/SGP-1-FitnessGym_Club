{"version":3,"file":"parser.js","sources":["../src/parser.ts"],"sourcesContent":["import type { Header } from \"./protocol/protocol\";\nimport { log } from \"./logger\";\n\nexport type ParsedMessageType = {\n  method: string;\n  header: Header;\n  payload: string;\n};\n\nfunction byteLength(s: string): number {\n  const escstr = encodeURIComponent(s);\n  const binstr = escstr.replace(/%([0-9A-F]{2})/g, (match, p1) =>\n    String.fromCharCode(Number(\"0x\" + p1))\n  );\n  return binstr.length;\n}\n\nfunction stringToUint8Array(s: string): Uint8Array {\n  const escstr = encodeURIComponent(s);\n  const binstr = escstr.replace(/%([0-9A-F]{2})/g, (match, p1) =>\n    String.fromCharCode(Number(\"0x\" + p1))\n  );\n  const ua = new Uint8Array(binstr.length);\n  Array.prototype.forEach.call(binstr, (ch, i) => {\n    ua[i] = ch.charCodeAt(0);\n  });\n  return ua;\n}\n\nfunction uint8ArrayToString(ua: Uint8Array): string {\n  const binstr = Array.prototype.map\n    .call(ua, (ch) => String.fromCharCode(ch))\n    .join(\"\");\n  const escstr = binstr.replace(/(.)/g, (m, p) => {\n    let code = p.charCodeAt(0).toString(16).toUpperCase();\n    if (code.length < 2) {\n      code = \"0\" + code;\n    }\n    return \"%\" + code;\n  });\n  return decodeURIComponent(escstr);\n}\n\nfunction getJsonObject(array: Uint8Array): Record<string, unknown> {\n  return JSON.parse(uint8ArrayToString(array));\n}\n\nfunction getMagic(buffer: Uint8Array) {\n  let strMagic = \"\";\n  let idx = 0;\n  for (; idx < buffer.length; ++idx) {\n    const chr = String.fromCharCode(buffer[idx]);\n    strMagic += chr;\n    if (chr === \"\\r\") {\n      idx += 2;\n      break;\n    }\n  }\n\n  const magics = strMagic.split(\" \");\n  return {\n    size: idx,\n    protocol: magics[0],\n    version: magics[1],\n    headerSize: Number(magics[2]),\n  };\n}\n\nclass Parser {\n  static parse(message: ArrayBufferLike): ParsedMessageType | null {\n    const fieldMargin = 2;\n\n    const dataView = new Uint8Array(message);\n    const magic = getMagic(dataView);\n    if (magic.protocol !== \"TWILSOCK\" || magic.version !== \"V3.0\") {\n      log.error(`unsupported protocol: ${magic.protocol} ver ${magic.version}`);\n      //throw new Error('Unsupported protocol');\n      //this.fsm.unsupportedProtocol();\n      return null;\n    }\n\n    let header;\n    try {\n      header = getJsonObject(\n        dataView.subarray(magic.size, magic.size + magic.headerSize)\n      );\n    } catch (e) {\n      log.error(\"failed to parse message header\", e, message);\n      //throw new Error('Failed to parse message');\n      //this.fsm.protocolError();\n      return null;\n    }\n\n    log.debug(\"message received: \", header.method);\n    log.trace(\"message received: \", header);\n\n    let payload;\n    if (header.payload_size > 0) {\n      const payloadOffset = fieldMargin + magic.size + magic.headerSize;\n      const payloadSize = header.payload_size;\n\n      if (\n        !header.hasOwnProperty(\"payload_type\") ||\n        header.payload_type.indexOf(\"application/json\") === 0\n      ) {\n        try {\n          payload = getJsonObject(\n            dataView.subarray(payloadOffset, payloadOffset + payloadSize)\n          );\n        } catch (e) {\n          log.error(\"failed to parse message body\", e, message);\n          //this.fsm.protocolError();\n          return null;\n        }\n      } else if (header.payload_type.indexOf(\"text/plain\") === 0) {\n        payload = uint8ArrayToString(\n          dataView.subarray(payloadOffset, payloadOffset + payloadSize)\n        );\n      }\n    }\n\n    return { method: header.method, header, payload };\n  }\n\n  static createPacket(\n    header: Partial<Header>,\n    payloadString = \"\"\n  ): ArrayBuffer {\n    header.payload_size = byteLength(payloadString); // eslint-disable-line camelcase\n\n    const headerString = JSON.stringify(header);\n    const magicString = \"TWILSOCK V3.0 \" + byteLength(headerString);\n\n    log.debug(\"send request:\", magicString + headerString + payloadString);\n\n    const message = stringToUint8Array(\n      magicString + \"\\r\\n\" + headerString + \"\\r\\n\" + payloadString\n    );\n    return message.buffer as ArrayBuffer;\n  }\n}\n\nexport { Parser };\n"],"names":["log"],"mappings":"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"}