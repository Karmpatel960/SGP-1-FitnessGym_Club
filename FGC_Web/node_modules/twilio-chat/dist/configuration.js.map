{"version":3,"file":"configuration.js","sources":["../src/configuration.ts"],"sourcesContent":["import { CommandExecutor } from './commandexecutor';\nimport { ConfigurationResponse } from './interfaces/commands/configuration';\nimport { parse as parseDuration, toSeconds } from 'iso8601-duration';\nimport { Logger } from './logger';\n\nconst TYPING_TIMEOUT = 5;\nconst HTTP_CACHE_LIFETIME = 'PT5S';\nconst CONSUMPTION_HORIZON_SENDING_INTERVAL = 'PT5S';\nconst USER_INFOS_TO_SUBSCRIBE = 100;\n\nconst MINIMUM_RETRY_DELAY = 1000;\nconst MAXIMUM_RETRY_DELAY = 4000;\nconst MAXIMUM_ATTEMPTS_COUNT = 3;\nconst RETRY_WHEN_THROTTLED = true;\n\ninterface BackoffConfiguration {\n  min: number;\n  max: number;\n  maxAttemptsCount: number;\n}\n\ninterface ConfigurationServices {\n  commandExecutor: CommandExecutor;\n}\n\nclass Configuration {\n  public readonly links: {\n    myConversations: string;\n    conversations: string;\n    users: string;\n    currentUser: string;\n    typing: string;\n    mediaService: string;\n    messagesReceipts: string;\n  };\n\n  public readonly productId?: string;\n\n  public readonly typingIndicatorTimeoutOverride?: number;\n  public readonly typingIndicatorTimeoutDefault: number = TYPING_TIMEOUT * 1000;\n  public readonly backoffConfiguration: BackoffConfiguration;\n  public readonly retryWhenThrottled: boolean;\n\n  public readonly consumptionReportInterval: number;\n  public readonly userInfosToSubscribe: number;\n  public readonly httpCacheInterval: number;\n  public readonly reachabilityEnabled: boolean;\n\n  public readonly userIdentity: string;\n  public readonly userInfo: string;\n  public readonly myConversations: string;\n\n  constructor(\n    options: Record<string, any> = {},\n    configurationResponse: ConfigurationResponse,\n    logger: Logger\n  ) {\n    const constructorOptions = options.Chat || options.IPMessaging || options || {};\n\n    this.productId = constructorOptions.productId;\n\n    this.links = {\n      myConversations: configurationResponse.links.my_conversations,\n      conversations: configurationResponse.links.conversations,\n      users: configurationResponse.links.users,\n      currentUser: configurationResponse.links.current_user,\n      typing: configurationResponse.links.typing,\n      mediaService: configurationResponse.links.media_service,\n      messagesReceipts: configurationResponse.links.messages_receipts\n    };\n\n    this.typingIndicatorTimeoutOverride = constructorOptions.typingIndicatorTimeoutOverride;\n    this.backoffConfiguration = {\n      min: MINIMUM_RETRY_DELAY,\n      max: MAXIMUM_RETRY_DELAY,\n      maxAttemptsCount: MAXIMUM_ATTEMPTS_COUNT,\n      ...constructorOptions.backoffConfigOverride\n    };\n    this.retryWhenThrottled = constructorOptions.retryWhenThrottledOverride !== undefined\n      ? constructorOptions.retryWhenThrottledOverride\n      : RETRY_WHEN_THROTTLED;\n    this.userInfosToSubscribe = constructorOptions.userInfosToSubscribeOverride\n      || configurationResponse.options.user_infos_to_subscribe\n      || USER_INFOS_TO_SUBSCRIBE;\n    this.reachabilityEnabled = configurationResponse.options.reachability_enabled;\n    this.userIdentity = configurationResponse.identity;\n    this.userInfo = configurationResponse.sync_objects.my_user_info;\n    this.myConversations = configurationResponse.sync_objects.my_conversations;\n\n    const httpCacheInterval = constructorOptions.httpCacheIntervalOverride\n      || configurationResponse.options.http_cache_interval\n      || HTTP_CACHE_LIFETIME;\n\n    try {\n      this.httpCacheInterval = toSeconds(parseDuration(httpCacheInterval));\n    } catch {\n      logger.error(`Failed to parse http cache interval ${httpCacheInterval}, using default value ${HTTP_CACHE_LIFETIME}`);\n      this.httpCacheInterval = toSeconds(parseDuration(HTTP_CACHE_LIFETIME));\n    }\n\n    const consumptionReportInterval = constructorOptions.consumptionReportIntervalOverride\n      || configurationResponse.options.consumption_report_interval\n      || CONSUMPTION_HORIZON_SENDING_INTERVAL;\n\n    try {\n      this.consumptionReportInterval = toSeconds(parseDuration(consumptionReportInterval));\n    } catch {\n      logger.error(\n        `Failed to parse consumption report interval ${consumptionReportInterval}, using default value ${CONSUMPTION_HORIZON_SENDING_INTERVAL}`\n      );\n      this.consumptionReportInterval = toSeconds(parseDuration(CONSUMPTION_HORIZON_SENDING_INTERVAL));\n    }\n  }\n}\n\nexport { Configuration };"],"names":["toSeconds","parseDuration"],"mappings":"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"}