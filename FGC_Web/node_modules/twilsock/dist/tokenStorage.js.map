{"version":3,"file":"tokenStorage.js","sources":["../src/tokenStorage.ts"],"sourcesContent":["class TokenStorage {\n  private initializedFlag = \"twilio_twilsock_token_storage\";\n  private tokenStoragePrefix = \"twilio_continuation_token_\";\n  private static _instance: TokenStorage | null = null;\n\n  constructor() {\n    if (!TokenStorage._instance) {\n      this.initialize();\n      TokenStorage._instance = this;\n    }\n    return TokenStorage._instance;\n  }\n\n  public sessionStorage(): Storage | null {\n    try {\n      return global[\"sessionStorage\"];\n    } catch (err) {\n      return null;\n    }\n  }\n\n  public window(): Window | null {\n    try {\n      return global[\"window\"];\n    } catch (err) {\n      return null;\n    }\n  }\n\n  public storeToken(continuationToken: string, productId: string): void {\n    if (this.canStore()) {\n      this.sessionStorage.setItem(\n        this.getKeyName(productId),\n        continuationToken\n      );\n    }\n  }\n\n  public getStoredToken(productId: string): string | null {\n    if (!this.canStore()) {\n      return null;\n    }\n\n    return this.sessionStorage.getItem(this.getKeyName(productId));\n  }\n\n  private initialize(): void {\n    if (this.canStore()) {\n      const flag = this.sessionStorage.getItem(this.initializedFlag);\n\n      // Duplicated tab, cleaning up all stored keys\n      if (flag) {\n        this.clear();\n      }\n      this.sessionStorage.setItem(this.initializedFlag, \"true\");\n\n      // When leaving page or refreshing\n      const removeStorageItem = this.sessionStorage.removeItem;\n      this.window.addEventListener(\"unload\", () => {\n        removeStorageItem(this.initializedFlag);\n      });\n    }\n  }\n\n  public clear(): void {\n    if (this.canStore()) {\n      const keyToDelete: string[] = [];\n      for (let i = 0; i < this.sessionStorage.length; i++) {\n        const key = this.sessionStorage.key(i);\n        // We manually removed startsWith here due to some problems with babel polyfill setup.\n        // Restore it when we figure out what's wrong.\n        //if (key.startsWith(TokenStorage.tokenStoragePrefix)) {\n        if (key && key.indexOf(this.tokenStoragePrefix) === 0) {\n          keyToDelete.push(key);\n        }\n      }\n      const removeStorageItem = this.sessionStorage.removeItem;\n      keyToDelete.forEach((key) => removeStorageItem(key));\n      removeStorageItem(this.initializedFlag);\n    }\n  }\n\n  private getKeyName(productId: string) {\n    return `${this.tokenStoragePrefix}${productId}`;\n  }\n\n  private canStore(): this is TokenStorage & {\n    window: Window;\n    sessionStorage: Storage;\n  } {\n    return !!(this.sessionStorage && this.sessionStorage.length && this.window);\n  }\n}\n\nexport default new TokenStorage();\n"],"names":[],"mappings":"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"}