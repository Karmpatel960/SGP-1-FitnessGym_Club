{"version":3,"file":"registrations.js","sources":["../../src/services/registrations.ts"],"sourcesContent":["import { log } from \"../logger\";\nimport { EventEmitter } from \"events\";\nimport { v4 as uuid } from \"uuid\";\nimport type { Context, MessageType } from \"../protocol/protocol\";\nimport { PacketInterface } from \"../packetinterface\";\nimport { TwilsockError } from \"../error/twilsockerror\";\n\n/**\n * Registrations module handles all operations with registration contexts through twilsock.\n * Main role: it automatically refreshes all registrations after reconnect.\n */\nclass Registrations extends EventEmitter {\n  private readonly registrations: Map<string, Context>;\n  private readonly registrationsInProgress: Map<string, Set<unknown>>;\n\n  constructor(private readonly transport: PacketInterface) {\n    super();\n\n    this.registrations = new Map();\n    this.registrationsInProgress = new Map();\n  }\n\n  private async putNotificationContext(\n    contextId: string,\n    context: Context\n  ): Promise<void> {\n    const header = {\n      method: \"put_notification_ctx\" as MessageType,\n      notification_ctx_id: contextId,\n    };\n    await this.transport.sendWithReply(header, context);\n  }\n\n  private async deleteNotificationContext(contextId: string): Promise<void> {\n    const message = {\n      method: \"delete_notification_ctx\" as MessageType,\n      notification_ctx_id: contextId,\n    };\n    await this.transport.sendWithReply(message);\n  }\n\n  private async updateRegistration(contextId: string, context: Context) {\n    log.debug(\"update registration for context\", contextId);\n\n    let registrationAttempts = this.registrationsInProgress.get(contextId);\n    if (!registrationAttempts) {\n      registrationAttempts = new Set();\n      this.registrationsInProgress.set(contextId, registrationAttempts);\n    }\n\n    const attemptId = uuid();\n    registrationAttempts.add(attemptId);\n\n    try {\n      await this.putNotificationContext(contextId, context);\n\n      log.debug(\"registration attempt succeeded for context\", context);\n      registrationAttempts.delete(attemptId);\n      if (registrationAttempts.size === 0) {\n        this.registrationsInProgress.delete(contextId);\n        this.emit(\"registered\", contextId);\n      }\n    } catch (err) {\n      log.warn(\"registration attempt failed for context\", context);\n      log.debug(err);\n\n      registrationAttempts.delete(attemptId);\n      if (registrationAttempts.size === 0) {\n        this.registrationsInProgress.delete(contextId);\n        this.emit(\"registrationFailed\", contextId, err);\n      }\n    }\n  }\n\n  public async updateRegistrations(): Promise<void> {\n    log.trace(`refreshing ${this.registrations.size} registrations`);\n    const promises: Promise<void>[] = [];\n    this.registrations.forEach((context: Context, id) => {\n      promises.push(this.updateRegistration(id, context));\n    });\n    await Promise.all(promises);\n  }\n\n  public async setNotificationsContext(\n    contextId: string,\n    context: Context\n  ): Promise<void> {\n    if (!contextId || !context) {\n      throw new TwilsockError(\"Invalid arguments provided\");\n    }\n\n    this.registrations.set(contextId, context);\n    return await this.updateRegistration(contextId, context);\n  }\n\n  public async removeNotificationsContext(contextId: string): Promise<void> {\n    if (!this.registrations.has(contextId)) {\n      return;\n    }\n\n    await this.deleteNotificationContext(contextId);\n    if (this.transport.isConnected) {\n      this.registrations.delete(contextId);\n    }\n  }\n}\n\nexport { Registrations };\n"],"names":["EventEmitter","log","uuid","TwilsockError"],"mappings":"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"}