{"version":3,"file":"network.js","sources":["../../src/services/network.ts"],"sourcesContent":["import { Retrier } from \"@twilio/operation-retrier\";\nimport { Logger } from \"../logger\";\nimport { Configuration } from \"../configuration\";\nimport { Transport } from \"./transport\";\nimport { MediaCategory } from \"../media\";\n\nconst log = Logger.scope(\"Network\");\n\nclass Network {\n  private readonly config: Configuration;\n  private readonly transport: Transport;\n\n  constructor(config: Configuration, transport: Transport) {\n    this.config = config;\n    this.transport = transport;\n  }\n\n  private backoffConfig() {\n    return Object.assign(\n      Configuration.backoffConfigDefault,\n      this.config.backoffConfigOverride\n    );\n  }\n\n  private retryWhenThrottled(): boolean {\n    return (\n      this.config.retryWhenThrottledOverride ??\n      Configuration.retryWhenThrottledDefault ??\n      false\n    );\n  }\n\n  private async executeWithRetry(\n    request,\n    retryWhenThrottled: boolean\n  ): Promise<any> {\n    return new Promise((resolve, reject) => {\n      const codesToRetryOn = [502, 503, 504];\n      if (retryWhenThrottled) {\n        codesToRetryOn.push(429);\n      }\n\n      const retrier = new Retrier(this.backoffConfig());\n      retrier.on(\"attempt\", async () => {\n        try {\n          const result = await request();\n          retrier.succeeded(result);\n        } catch (err) {\n          if (codesToRetryOn.indexOf(err.status) > -1) {\n            retrier.failed(err);\n          } else if (err.message === \"Twilsock disconnected\") {\n            // Ugly hack. We must make a proper exceptions for twilsock\n            retrier.failed(err);\n          } else {\n            // Fatal error\n            retrier.removeAllListeners();\n            retrier.cancel();\n            reject(err);\n          }\n        }\n      });\n\n      retrier.on(\"succeeded\", (result) => {\n        resolve(result);\n      });\n      retrier.on(\"cancelled\", (err) => reject(err));\n      retrier.on(\"failed\", (err) => reject(err));\n\n      retrier.start();\n    });\n  }\n\n  public async get(url: string): Promise<any> {\n    const headers = { \"X-Twilio-Token\": this.config.token };\n    log.trace(\"sending GET request to \", url, \" headers \", headers);\n    try {\n      const response = await this.executeWithRetry(\n        () => this.transport.get(url, headers),\n        this.retryWhenThrottled()\n      );\n      log.trace(\"response\", response);\n      return response;\n    } catch (err) {\n      log.debug(`get() error ${err}`);\n      throw err;\n    }\n  }\n\n  public async post(\n    url: string,\n    category: MediaCategory | null,\n    media: string | Buffer | Blob | FormData | Record<string, unknown>,\n    contentType?: string,\n    filename?: string\n  ): Promise<any> {\n    const headers = {\n      \"X-Twilio-Token\": this.config.token,\n    };\n\n    if (\n      (typeof FormData === \"undefined\" || !(media instanceof FormData)) &&\n      contentType\n    ) {\n      Object.assign(headers, {\n        \"Content-Type\": contentType,\n      });\n    }\n\n    const fullUrl = new URL(url);\n    if (category) {\n      fullUrl.searchParams.append(\"Category\", category);\n    }\n    if (filename) {\n      fullUrl.searchParams.append(\"Filename\", filename);\n    }\n\n    let response;\n    log.trace(`sending POST request to ${url} with headers ${headers}`);\n    try {\n      response = await this.transport.post(fullUrl.href, headers, media);\n    } catch (err) {\n      // If global[\"XMLHttpRequest\"] is undefined, it means that the code is\n      // not being executed in the browser.\n      if (global[\"XMLHttpRequest\"] === undefined && media instanceof FormData) {\n        throw new TypeError(\n          \"Posting FormData supported only with browser engine's FormData\"\n        );\n      }\n      log.debug(`post() error ${err}`);\n      throw err;\n    }\n    log.trace(\"response\", response);\n    return response;\n  }\n}\n\nexport { Network };\n"],"names":["Logger","Configuration","Retrier"],"mappings":"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"}